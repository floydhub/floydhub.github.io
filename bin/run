#!/bin/bash

# FloydHub Blog Local Development Server
# Runs Jekyll server locally for testing changes before deploying

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}🚀 FloydHub Blog Local Development Server${NC}"
echo -e "${BLUE}=========================================${NC}"

# Check if we're in the right directory
if [ ! -f "_config.yml" ]; then
    echo -e "${RED}❌ Error: _config.yml not found. Are you in the blog root directory?${NC}"
    exit 1
fi

# Check if Jekyll is installed
if ! command -v jekyll &> /dev/null; then
    echo -e "${YELLOW}⚠️  Jekyll not found. Attempting to install...${NC}"

    # Check if bundler is available
    if command -v bundle &> /dev/null; then
        echo -e "${BLUE}📦 Installing dependencies with bundle...${NC}"
        bundle install
    else
        echo -e "${RED}❌ Error: Neither Jekyll nor Bundle found.${NC}"
        echo -e "${YELLOW}Please install Jekyll:${NC}"
        echo -e "  ${YELLOW}gem install jekyll bundler${NC}"
        echo -e "  ${YELLOW}or visit: https://jekyllrb.com/docs/installation/${NC}"
        exit 1
    fi
fi

# Install/update dependencies if Gemfile exists
if [ -f "Gemfile" ]; then
    echo -e "${BLUE}📦 Checking dependencies...${NC}"
    if command -v bundle &> /dev/null; then
        bundle install --quiet
    else
        echo -e "${YELLOW}⚠️  Bundle not available, skipping dependency check${NC}"
    fi
fi

echo ""
echo -e "${GREEN}✅ Starting Jekyll development server...${NC}"
echo -e "${BLUE}📍 Site will be available at: http://localhost:4000${NC}"
echo -e "${BLUE}📍 Post URL: http://localhost:4000/metrics-on-floydhub/${NC}"
echo ""
echo -e "${YELLOW}💡 Tips:${NC}"
echo -e "${YELLOW}   • Press Ctrl+C to stop the server${NC}"
echo -e "${YELLOW}   • Changes will auto-reload (except _config.yml)${NC}"
echo -e "${YELLOW}   • Restart server if you modify _config.yml${NC}"
echo ""

# Start Jekyll with development settings
if command -v bundle &> /dev/null && [ -f "Gemfile" ]; then
    # Use bundle exec for better dependency management
    bundle exec jekyll serve \
        --host=0.0.0.0 \
        --port=4000 \
        --livereload \
        --incremental \
        --draft \
        --future \
        --config _config.yml
else
    # Fallback to direct Jekyll command
    jekyll serve \
        --host=0.0.0.0 \
        --port=4000 \
        --livereload \
        --incremental \
        --draft \
        --future \
        --config _config.yml
fi